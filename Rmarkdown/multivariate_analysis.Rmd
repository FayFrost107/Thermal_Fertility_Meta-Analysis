---
title: "Multivariate Meta-Analysis for Longevity and Reproduction"
author: "Daniel Noble & Fay Frost"
output: pdf_document
editor_options: 
  chunk_output_type: console
---

```{r, packages,echo = FALSE}
install.packages("pacman")
pacman::p_load(tidyverse, here, metafor)
```

```{r, load data, echo = FALSE}
## Load in the finalised data
  data <- read.csv(here("data", "cleaned_unique_combo.csv"))
```

```{r, check data, echo = FALSE, include=FALSE}

#  Let's just orient the data length wise as we need it in this format first.
  
  data_long <- data %>% pivot_longer(cols = c(es_reproduction, es_longevity, v_reproduction, v_longevity), names_to = "outcome", values_to = "es") %>% data.frame()
  
  # Not quite where we need it, so lets filter out v and then cbind together
  data_long_es <- data_long %>% filter(outcome %in% c("es_reproduction", "es_longevity"))
   data_long_v <- data_long %>% filter(outcome %in% c("v_reproduction", "v_longevity"))
  
  # All information should now be ordered correctly and the data frames the same dimensions. We can check
  dim(data_long_es)
  dim(data_long_v)
  
# Now, bind these together
  data_long_final <- cbind(data_long_es, v = data_long_v$es)
  
# Create unique ID for clustered effects
  data_long_final$trial <- with(data_long_final, interaction(Experiment.code, diff))
  
# Now, let's check that this data is set up correctly. If we group by Experiment.code, diff and outcome then we should have a maximum of 1 effect size for each study/diff in each outcome category
  check <- data_long_final %>% group_by(trial, outcome) %>% summarise(n=n()) %>% filter(n !=1)

# OUTCOME: There still appear to be columns(~40) with more than 1 effect size for each longevity/reproduction effect size. This is also not because we could have males and female effect sizes as including sex does not resolve this problem
  
# The Experiment code identifiers that are relevant are:
  unique(check$trial)
  
```

```{r, multivariatemodel}

# VCV matrix. Let's set up the multivariate meta-analysis model. We first need to create the VCV sampling matrix. This is a block diagonal matrix with the sampling variance for each effect size on the diagonal and the sampling covariance between the two effect sizes on the off-diagonal. We don't know the correlation, but we can assume 0.5. 
  
  V <- metafor::vcalc(vi=v, cluster = trial, data = data_long_final, rho = 0.5, nearpd = TRUE)

# Check that this is set up correctly. Note that there are warnings about non-positive definite matrix. The matrix should be automatically. 
  V[1:6, 1:6]

# Multivariate model. Using the VCV matrix we can set up the model. We'll keep it simple for now

mv_mlma <- rma(es ~ outcome - 1, V = V, random = list(~outcome - 1 | trial), struc = "UN", data = data_long)


```

