---
title: "Multivariate Meta-Analysis for Longevity"
author: "Daniel Noble & Fay Frost"
format: docx
execute:
  freeze: auto  # re-render only when source changes
cache: false
echo: false
warning: false
error: false
include: true
crossref:
  fig-title: 'Figure'
fig-labels: arabic
title-delim: "-"
fig-prefix: "Figure"
tbl-prefix: "Table"
---
  
```{r, packages}
#| echo: false
#| warning: false
#| include: false
#| eval: true
#install.packages("pacman")
#devtools::install_github("daniel1noble/metaAidR", force=TRUE)
pacman::p_load(tidyverse, here, ggplot2, rotl, multicomp, dplyr, clubSandwich, tidyr,  metafor, ape, phytools, corrplot, metaAidR, orchaRd, latex2exp, flextable)
# source functions
source(here("R", "func.R"))
options(digits = 6)
```

```{r, rerun}
#| echo: false
#| warning: false
#| include: false
#| eval: true

## rerun all models?
rerun <- FALSE
```

```{r, load data}
#| echo: false
#| warning: false
#| include: false

### Read in effect size data
effectdata <- read.csv(here("Data", "Survival project all pairwise.es.csv"))

### select data for analysis
longdata_warm <- subset(effectdata, Trait.category == "Longevity" & warm.cool == "Warm" )
longdata_cool <- subset(effectdata, Trait.category == "Longevity" & warm.cool == "Cool" )
alllong <- rbind(longdata_warm, longdata_cool)
rdata <- alllong

### Species names which need changing for phylogeny. 
rdata$Species.latin[which(rdata$Species.latin == "Cosmocomoidea ashmeadi")]              <- "Gonatocerus ashmeadi"	
rdata$Species.latin[which(rdata$Species.latin == "Cosmocomoidea triguttata")]   <- "Gonatocerus triguttatus"
rdata$Species.latin[which(rdata$Species.latin == "Mythimna roseilinea")]            <-  "Mythimna albipuncta"
rdata$Species.latin[which(rdata$Species.latin == "Daphnia australis")]            <-  "Daphniopsis australis"

### Create random factors into data frame 
rdata$obs <- factor(c(1:nrow(rdata)))                # Unique observation code
rdata$study_code <- factor(rdata$Paper.code)         # Model requires column names study_code (this is biggest level of nested code structure)
rdata$Species.phylo <- factor(rdata$Species.latin)   # Species names for phylo matrix
rdata$species <- factor(rdata$Species.latin)         # Another species column for ranom factor 

precision <- sqrt(1/rdata$v)                         # inverse standard error 
rdata[,"precision"] <- precision
str(rdata)

nlevels(rdata$species)    # Check number of species
nlevels(rdata$study_code) # Check number of studies

#### Import Tree #############
tree1 <- read.nexus(here("Phylogeny", "all_long_excHUM251_tree.nex"))
tree_grafen = compute.brlen(tree1, method="Grafen", power=1)
tree <- ape::multi2di(tree_grafen, random = TRUE) 
phylo_matrix <- vcv(tree_grafen, cor=TRUE, model="Brownian") # Make phylogenetic matrix

# use a randomization approach to deal with polytomies. 
# Could this this approach or another detailed here: https://search.r-project.org/CRAN/refmans/RRphylo/html/fix.poly.html

saveRDS(rdata, here("Output", "Output data", "longevity", "data_full_longevity.rds"))
```



# Results   


```{r}
#| echo: false
#| warning: false
#| include: false
#| 
# Simple model (no random effects)
if(rerun){
meta1 <- rma.uni(es, v, data= rdata, method= "REML")
summary(meta1)}
```

```{r}
#| echo: false
#| warning: false
#| include: false
#| 

# Adding four random factors
if(rerun){
meta2 <- rma.mv(es, v, random= list(~ 1|Species.phylo, ~ 1|species, ~ 1|study_code, ~1|obs), 
                R= list(Species.phylo = phylo_matrix), data= rdata, method= "REML")
  saveRDS(meta2, here("Output", "models", "longevity", "mv_long_2.rds"))
} else { 
   meta2 <- readRDS(here("Output", "models", "longevity", "mv_long_2.rds"))
  }
```


```{r}
#| echo: false
#| warning: false
#| include: false

# Assumes a correlation of 0.5 between effect sizes from the same experiment 
rdata$shared_control <- factor(rdata$Effect.size.code)
VCV_shared <- impute_covariance_matrix(vi=rdata$v, cluster = rdata$shared_control, r=0.5)


# Add new variance matrix for shared_control into the mixed-effects meta-analysis model
if(rerun){
meta3 <- rma.mv(es, VCV_shared, random= list(~ 1|Species.phylo, ~ 1|species, ~ 1|study_code, ~1|obs), 
                R= list(Species.phylo = phylo_matrix), data= rdata, method= "REML")
 saveRDS(meta3, here("Output", "models", "longevity", "mv_long_3.rds"))
} else { 
  meta3 <-  readRDS(here("Output", "models", "longevity", "mv_long_3.rds"))
  }
```

# Random effects models

### Intercept only model

At 25C the mean effect size for longevity was significantly negative (est = `r meta3$b`, 95% CI: `r meta3$ci.lb` to `r meta3$ci.ub`, *p*-value = `r p_value(meta3$pval)`). The estimated I2 for each random effect was I2[Total] = `r i2_ml(meta3, method=c("ratio"))[1]`%, I2[Phylogeny]= `r i2_ml(meta3, method=c("ratio"))[2]`%,  I2[species]= `r i2_ml(meta3, method=c("ratio"))[3]`%, I2[study]=`r i2_ml(meta3, method=c("ratio"))[4]`%, I2[obs]=`r i2_ml(meta3, method=c("ratio"))[5]`%

```{r}
#| echo: false
#| warning: false
#| include: true
#| eval: false
summary(meta3)
i2_ml(meta3, method=c("ratio"))
```



```{r, meta4-7}
#| echo: false
#| warning: false
#| include: false
#| 

if(rerun){
  ## without phylogeny or species
  meta4 <- rma.mv(es, VCV_shared, random= list(~ 1|study_code, ~1|obs), data= rdata, method= "REML")
  saveRDS(meta4, here("Output", "models", "longevity", "mv_long_4.rds"))
  
  ## without phylogeny 
  meta5 <- rma.mv(es, VCV_shared, random= list(~ 1|species, ~ 1|study_code,  ~1|obs), data= rdata, method= "REML")
  saveRDS(meta5, here("Output", "models", "longevity", "mv_long_5.rds"))
  
  ## without phylogeny, species or study_code 
  meta7 <- rma.mv(es, VCV_shared, random= list(~1|obs), data= rdata, method= "REML")
  saveRDS(meta7, here("Output", "models", "longevity", "mv_long_7.rds"))
} else {
  meta4 <- readRDS(here("Output", "models", "longevity", "mv_long_4.rds"))
  meta5 <- readRDS(here("Output", "models", "longevity",  "mv_long_5.rds"))
  meta7 <- readRDS(here("Output", "models", "longevity", "mv_long_7.rds"))
}


```

### Random effects combinations
We then fit the models with different combinations of random effects. The best fitting model according to AIC used only study_ID and observation_ID as random effects with `r round(i2_ml(meta4)[2],2)`% and  `r round(i2_ml(meta4)[3],2)`% estimated heterogeneity respectively. We used this random effects model as a base for our meta-regression models. 


# Meta-Regressions 

## How does temperature affect longevity?

```{r, regressionmodels}
#| echo: false
#| warning: false
#| include: false
#| 

if(rerun){
  # warm/cool
  meta_trait_warm <- rma.mv(es, VCV_shared,  mod= ~warm.cool, random= list(~ 1|study_code,  ~1|obs), data= rdata, method= "REML")
  saveRDS(meta_trait_warm, here("Output", "models", "longevity", "mv_long_warm.rds"))
  
  # warm/cool -1
  meta_trait_warm_nointer <- rma.mv(es, VCV_shared,  mod= ~warm.cool-1, random= list(~ 1|study_code,  ~1|obs), data= rdata, method= "REML")
  saveRDS(meta_trait_warm_nointer, here("Output", "models", "longevity", "mv_long_warm-1.rds"))
  
  
  # ref temp
  meta_trait_ref <- rma.mv(es, VCV_shared,  mod= ~reftemp, random= list(~ 1|study_code,  ~1|obs), data= rdata, method= "REML")
  saveRDS(meta_trait_ref, here("Output", "models", "longevity", "mv_long_ref.rds"))
  
  
  # treat temp centered
  meta_trait_treattemp <- rma.mv(es, VCV_shared,  mod= ~c_treattemp, random= list(~ 1|study_code,  ~1|obs), data= rdata, method= "REML")
  saveRDS(meta_trait_treattemp, here("Output", "models", "longevity", "mv_long_ctemp.rds"))
  
  
  # treat temp^2 centered
  meta_trait_treat2 <- rma.mv(es, VCV_shared,  mod= ~poly(c_treattemp, degree=2, raw=TRUE), random= list(~ 1|study_code,  ~1|obs), data= rdata, method= "REML")
  saveRDS(meta_trait_treat2, here("Output", "models", "longevity",  "mv_long_ctemp2.rds"))
  
  # treat temp^3 centered
  meta_trait_treat3 <- rma.mv(es, VCV_shared,  mod= ~ poly(c_treattemp, degree=3, raw=TRUE), random= list(~ 1|study_code,  ~1|obs), data= rdata, method= "REML")
  saveRDS(meta_trait_treat3, here("Output", "models", "longevity", "mv_long_ctemp3.rds"))
  
    # treat temp^4 centered
  meta_trait_treat4 <- rma.mv(es, VCV_shared,  mod= ~ poly(c_treattemp, degree=4, raw=TRUE), random= list(~ 1|study_code,  ~1|obs), data= rdata, method= "REML")
  saveRDS(meta_trait_treat3, here("Output", "models", "longevity", "mv_long_ctemp4.rds"))
  
  
  # diff temp
  meta_trait_diff <- rma.mv(es, VCV_shared,  mod= ~diff, random= list(~ 1|study_code,  ~1|obs), data= rdata, method= "REML")
  saveRDS(meta_trait_diff, here("Output", "models", "longevity", "mv_long_diff.rds"))
  
  
  ### binned treatment max temperatures.
  rdata$bin.temp <- c(NA)
  
  rdata$bin.temp[which(rdata$treattemp >= 40)] <- ">40" 
  rdata$bin.temp[which(rdata$treattemp >= 35 & rdata$treattemp <40)] <- "35-40" 
  rdata$bin.temp[which(rdata$treattemp >= 30 & rdata$treattemp <35)] <- "30-35" 
  rdata$bin.temp[which(rdata$treattemp >= 25 & rdata$treattemp <30)] <- "25-30" 
  rdata$bin.temp[which(rdata$treattemp >= 20 & rdata$treattemp <25)] <- "20-25"
  rdata$bin.temp[which(rdata$treattemp >= 15 & rdata$treattemp <20)] <- "15-20"
  rdata$bin.temp[which(rdata$treattemp <15)] <- "<15" 
  
  rdata$bin.temp <- factor(rdata$bin.temp)
  
  levels(rdata$bin.temp)
  table(rdata$bin.temp)
  
  # binned temps
  meta_trait_bintemp <- rma.mv(es, VCV_shared,  mod= ~bin.temp-1,  
                               random= list(~ 1|study_code,  ~1|obs), data= rdata, method= "REML")
  
  saveRDS(meta_trait_bintemp, here("Output", "models", "longevity", "mv_long_bintemp.rds"))
  
} else {
  meta_trait_warm  <- readRDS(here("Output", "models", "longevity", "mv_long_warm.rds"))
  meta_trait_warm_nointer  <- readRDS(here("Output", "models", "longevity", "mv_long_warm-1.rds"))
  meta_trait_ref <- readRDS(here("Output", "models", "longevity", "mv_long_ref.rds"))
  meta_trait_treattemp  <- readRDS(here("Output", "models", "longevity", "mv_long_ctemp.rds"))
  meta_trait_treat2  <- readRDS(here("Output", "models", "longevity", "mv_long_ctemp2.rds"))
  meta_trait_diff <- readRDS(here("Output", "models", "longevity", "mv_long_diff.rds"))
  meta_trait_bintemp <-  readRDS(here("Output", "models", "longevity", "mv_long_bintemp.rds"))
  meta_trait_treat3 <- readRDS(here("Output", "models", "longevity", "mv_long_ctemp3.rds"))
  meta_trait_treat4 <- readRDS(here("Output", "models", "longevity", "mv_long_ctemp4.rds"))
}

```

Across all taxa, longevity exhibited a significant cubic relationship with temperature (QM=`r meta_trait_treat3$QM`, P = `r meta_trait_treat3$QMp`) (@tbl-treat3): longevity peaked around 15Â°C, and decreased either side of this (@fig-treat3). The inclusion of phylogenetic relatedness did not result in an improved model fit, as evidenced by the change in Akaike Information Criterion (AIC). Consequently, phylogeny was excluded from the model. Nevertheless, it's worth noting that there was a significant level of variability in lifespan responses to temperature, with a total I2 of `r i2_ml(meta_trait_treat3)[1]`%. The effect size at the observation level (ID) accounted for  `r i2_ml(meta_trait_treat3)[3]`% of this variability, while study-level ID contributed to `r i2_ml(meta_trait_treat3)[2]`%. Phylogeny, in contrast, had a negligible impact, explaining less than 0.001% of the variation.


```{r, tbl-treat3}
#| label: tbl-treat3
#| tbl-cap: Non-linear effects of temperature on mean effect size of longevity
table <- data.frame(Parameters = c("Longevity (mean)", "Linear Treatment Temperature (centered) - Longevity","Quadratic Treatment Temperature (centered) - Longevity", "Cubic Treatment Temperature (centered) - Longevity" ),
                    Est. = round(meta_trait_treat3$b, 4),
                    `L 95% CI` = round(meta_trait_treat3$ci.lb, 4),
                    `U 95% CI` = round(meta_trait_treat3$ci.ub, 4),
                    `p-value` = sapply(round(meta_trait_treat3$pval,4), function(x) p_value(x)), row.names = NULL, check.names = FALSE)
flextable(table)
```

```{r}
#| label: fig-treat3
#| fig-cap: Bubble plot of effect size of longevity when controlling for temperature. 
p <- bubble_plot(meta_trait_treat3, mod = "c_treattemp", group="study_code")
p+coord_cartesian(ylim=c(-10,10)) + labs(x = "Temperature deviation from 25C")
```

# How does sex exposed and life stage of exposure effect longevity?

```{r, lifestagesex}
#| echo: false
#| warning: false
#| include: false


## Sex exposed
# We could lump categories so that we have cases where males are included (Both, Male), versus cases with just females (Female, Parthenogenetic), 
# with Unsure removed. I would predict that the 'Both' category would show the biggest drop for longevity, but there will be no difference for lifespan

if(rerun){
  new_data <- rdata
  
  new_data$Sex.exposed[which(new_data$Sex.exposed == "Male")] <- "Both"
  new_data$Sex.exposed[which(new_data$Sex.exposed == "Parthenogenetic")] <- "Female"
  
  new_data <- subset(new_data, Sex.exposed != "Unsure")
  
  VCV_shared_sex <- impute_covariance_matrix(vi=new_data$v, cluster = new_data$shared_control, r=0.5)
  
  
  meta_treat_sex <- rma.mv(es, VCV_shared_sex,  mod= ~poly(c_treattemp, degree=3, raw=TRUE)*Sex.exposed-1, 
                           random= list(~ 1|study_code,  ~1|obs), data= new_data, method= "REML")
  
  meta_treat_sex_nointer <- rma.mv(es, VCV_shared_sex,  mod= ~poly(c_treattemp, degree=3, raw=TRUE)*Sex.exposed-1, 
                         random= list(~ 1|study_code,  ~1|obs), data= new_data, method= "REML")
  
  saveRDS(meta_treat_sex, here("Output", "models", "longevity", "meta_treat_long_sex.rds"))
  saveRDS(meta_treat_sex_nointer, here("Output", "models", "longevity", "meta_treat_sex_nointer.rds"))
  saveRDS(new_data, here("Output", "Output data",  "data_long_sex.rds"))
  
  
  ## Life-stage
  # We could lump categories so that we have cases where only adults were exposed (Adult), 
  # versus cases where immature stages were exposed (Juvenile, Larvae, Pupae, Mix)- perhaps after excluding 'Egg' and 'Embryo' because these categories are a bit weird
  
  ls_data <- rdata
  
  ls_data$Life.stage.of.animal[which(ls_data$Life.stage.of.animal == "Juvenile")] <- "Immature"
  ls_data$Life.stage.of.animal[which(ls_data$Life.stage.of.animal == "Larvae")] <- "Immature"
  ls_data$Life.stage.of.animal[which(ls_data$Life.stage.of.animal == "Mix")] <- "Immature"
  ls_data$Life.stage.of.animal[which(ls_data$Life.stage.of.animal == "Pupae")] <- "Immature"
  
  ls_data <- subset(ls_data, Life.stage.of.animal != "Egg")
  ls_data <- subset(ls_data, Life.stage.of.animal != "Embryo")
  
  VCV_shared_life <- impute_covariance_matrix(vi=ls_data$v, cluster = ls_data$shared_control, r=0.5)
  
  meta_treat_ls <- rma.mv(es, VCV_shared_life,  mod= ~poly(c_treattemp, degree=3, raw=TRUE)*Life.stage.of.animal,
                          random= list(~ 1|study_code,  ~1|obs), data= ls_data, method= "REML")
  
  
  meta_treat_ls_nointer <- rma.mv(es, VCV_shared_life,  mod= ~ -1 + poly(c_treattemp, degree=3, raw=TRUE)*Life.stage.of.animal,
                           random= list(~ 1|study_code,  ~1|obs), data= ls_data, method= "REML")


  saveRDS(meta_treat_ls, here("Output", "models", "longevity", "meta_treat_long_ls.rds"))
  saveRDS(meta_treat_ls_nointer, here("Output", "models", "longevity", "meta_treat_ls_nointer.rds"))
  saveRDS(ls_data, here("Output", "Output data", "data_long_ls.rds"))
} else {
  meta_treat_sex <- readRDS(here("Output", "models", "longevity", "meta_treat_long_sex.rds"))
  meta_treat_sex_nointer <- readRDS(here("Output", "models", "longevity", "meta_treat_sex_nointer.rds"))
  new_data <- readRDS(here("Output", "Output data", "data_long_sex.rds"))
  
  meta_treat_ls <- readRDS(here("Output", "models", "longevity", "meta_treat_long_ls.rds"))
  meta_treat_ls_nointer <- readRDS(here("Output", "models", "longevity", "meta_treat_ls_nointer.rds"))
  ls_data <- readRDS(here("Output", "Output data", "data_long_ls.rds"))
}

```



### sex exposed

The relationship between temperature and longevity did not depend on whether both males and females were exposed to experimental temperatures (N= `r length(which(new_data$Sex.exposed == "Both"))` effect sizes), or whether just females were exposed to experimental temperatures (N= `r length(which(new_data$Sex.exposed == "Female"))` effect sizes) (Interaction between the quadratic effect of (centered) temperature and sex exposed category, z=`r meta_treat_sex$zval[8]`, *p*-value = `r p_value(meta_treat_sex$pval[8])`).   
                                        
```{r, tbl-sex}
#| label: tbl-sex
#| tbl-cap: Non-linear effects of temperature and sex exposed on mean effect size of longevity
table <- data.frame(Parameters = c("Linear Treatment Temperature (centered) - Both","Quadratic Treatment Temperature (centered) - Both", "Cubic Treatment Temperature (centered) - Both", "Both (mean)", "Females only (mean)", "Treatment Temperature (centered) - Females only","Quadratic Treatment Temperature (centered) - Females only", "Cubic Treatment Temperature (centered) - Females only"),
                    Est. = round(meta_treat_sex_nointer$b, 4),
                    `L 95% CI` = round(meta_treat_sex_nointer$ci.lb, 4),
                    `U 95% CI` = round(meta_treat_sex_nointer$ci.ub, 4),
                    `p-value` = sapply(round(meta_treat_sex_nointer$pval,4), function(x) p_value(x)), row.names = NULL, check.names = FALSE)
flextable(table)
```

```{r, fig-figsex}
#| label: fig-figsex
#| fig-cap: Predicited models of sex exposed and temeprature effects on longevity.  

preds.rep.sex <- predict(meta_treat_sex, addx=TRUE)
sex_rep_data <- new_data

sex_rep_data$pred <- preds.rep.sex$pred  
sex_rep_data$pred.lb <- preds.rep.sex$pi.lb
sex_rep_data$pred.ub <- preds.rep.sex$pi.ub
sex_rep_data$c.lb <- preds.rep.sex$ci.lb
sex_rep_data$c.ub <- preds.rep.sex$ci.ub

library(ggplot2)

ggplot(data = sex_rep_data, aes(x = c_treattemp, y = pred, col = Sex.exposed, linetype = Sex.exposed)) +
  geom_ribbon(aes(ymin = c.lb, ymax = c.ub, fill = Sex.exposed), alpha = 0.15) +
  geom_line() +
  scale_color_manual(values = c("purple", "orange")) +  # Set colors for the points and lines
  scale_fill_manual(values = c("purple", "orange")) +    # Set colors for the ribbons
  scale_linetype_manual(values = c("solid", "dashed")) +
  theme_bw() + 
  labs(title = "Predicted emperature effect on longevity",
       x = "Temperature devaition from 25C",
       y = "Effect size",
       color = "Sex exposed",  # Set the title of the color legend
       fill = "Sex exposed",
       linetype = "Sex exposed")   # Set the title of the fill legend (for ribbons)
```


```{r, fig-figsexobs}
#| label: fig-figsexobs
#| fig-cap: Observed effects of sex exposed and temeprature on longevity.  

ggplot(data = sex_rep_data, aes(x = c_treattemp, y = es, col = Sex.exposed)) +
  geom_point( alpha=0.5)+
  scale_color_manual(values = c("purple", "orange")) +  # Set colors for the points and lines
  scale_fill_manual(values = c("purple", "orange")) + 
  theme_bw() + 
  labs(title = "Observed temperature effect on longevity",
       x = "Temperature devaition from 25C",
       y = "Effect size",
       color = "Sex exposed")   # Set the title of the fill legend (for ribbons)

```

### life stage of animal

The relationship between temperature and reproduction did not depend on whether subjects were exposed as adults only (N= `r length(which(ls_data$Life.stage.of.animal == "Adult"))` effect sizes), or across multiple life stages (N= `r length(which(ls_data$Life.stage.of.animal == "Immature"))`effect sizes) (Interaction between the quadratic effect of (centered) temperature and life stage category, z=`r meta_treat_ls$zval[8]`, *p*-value = `r p_value(meta_treat_ls$pval[8])`), Table (@tbl-ls). 

```{r, tbl-ls}
#| label: tbl-ls
#| tbl-cap: Non-linear effects of temperature and life stageo animal on mean effect size of longevity
table <- data.frame(Parameters = c("Linear Treatment Temperature (centered) - Adult","Quadratic Treatment Temperature (centered) - Adult", "Cubic Treatment Temperature (centered) - Adult",  "Adult (mean)", "Immature (mean)", "Treatment Temperature (centered) - Immature","Quadratic Treatment Temperature (centered) - Immature", "Cubic Treatment Temperature (centered) - Adult"),
                    Est. = round(meta_treat_ls_nointer$b, 4),
                    `L 95% CI` = round(meta_treat_ls_nointer$ci.lb, 4),
                    `U 95% CI` = round(meta_treat_ls_nointer$ci.ub, 4),
                    `p-value` = sapply(round(meta_treat_ls_nointer$pval,4), function(x) p_value(x)), row.names = NULL, check.names = FALSE)
flextable(table)
```


```{r, fig-figls}
#| label: fig-figls
#| fig-cap: Predicited models of sex exposed and temeprature effects on longevity.  

preds.rep.ls <- predict(meta_treat_ls, addx=TRUE)
ls_rep_data <- ls_data

ls_rep_data$pred <- preds.rep.ls$pred  
ls_rep_data$pred.lb <- preds.rep.ls$pi.lb
ls_rep_data$pred.ub <- preds.rep.ls$pi.ub
ls_rep_data$c.lb <- preds.rep.ls$ci.lb
ls_rep_data$c.ub <- preds.rep.ls$ci.ub

library(ggplot2)

ggplot(data = ls_rep_data, aes(x = c_treattemp, y = pred, col = Life.stage.of.animal, linetype = Life.stage.of.animal)) +
  geom_ribbon(aes(ymin = c.lb, ymax = c.ub, fill = Life.stage.of.animal), alpha = 0.15) +
  geom_line() +
  scale_color_manual(values = c("purple", "orange")) +  # Set colors for the points and lines
  scale_fill_manual(values = c("purple", "orange")) +    # Set colors for the ribbons
  scale_linetype_manual(values = c("solid", "dashed")) +
  theme_bw() + 
  labs(title = "Predicted temperature effect on longevity",
       x = "Observed temperature devaition from 25C",
       y = "Effect size",
       color = "Life stage",  # Set the title of the color legend
       fill = "Life stage",
       linetype = "Life stage")   # Set the title of the fill legend (for ribbons)
```

However, looking at the observed values, it is possible these model estimates are strongly driven by outlying values. 
```{r, fig-figlsobs}
#| label: fig-figlsobs
#| fig-cap: Observed effect sizes of sex and temeprature effects on longevity.  

### observed data 
ggplot(data = ls_rep_data, aes(x = c_treattemp, y = es, col = Life.stage.of.animal)) +
  geom_point( alpha=0.5)+
  scale_color_manual(values = c("purple", "orange")) +  # Set colors for the points and lines
  scale_fill_manual(values = c("purple", "orange")) + 
  theme_bw() + 
  coord_cartesian(ylim = c(-10,1))+
  labs(title = "Observed temperature effect on longevity",
       x = "Temperature devaition from 25C",
       y = "Effect size",
       color = "Life stage")   # Set the title of the fill legend (for ribbons)


```

# Publication Bias

```{r}
#| echo: false
#| warning: false
#| include: false

## Publication Bias.

if(rerun){
meta_year <- rma.mv(es, VCV_shared,  mod= ~Publication.year,  
                    random= list(~ 1|study_code,  ~1|obs), data= rdata, method= "REML")

saveRDS(meta_year, here("Output", "models", "longevity", "meta_long_year.rds"))


# Sensitivty Analysis
# Preform a sensitivity analysis by removing the smallest and largest 5% of effect sizes.


minq <- quantile(rdata$es, 0.05)
maxq <- quantile(rdata$es, 0.95)

sdata <- subset(rdata, es > minq & es < maxq)
saveRDS(sdata, here("Output", "Output data", "longevity", "sensitivity_data_long.rds"))


## Treatment temperature as a cubic effect (sesnsitivity analysis)

# re-cmpute the covariance matrix for subsetted data
VCV_shared_sa <- impute_covariance_matrix(vi=sdata$v, cluster = sdata$shared_control, r=0.5)


# re-run cubic model
meta_sa_treat3 <- rma.mv(es, VCV_shared_sa,  mod= ~poly(c_treattemp, degree=3, raw=TRUE), 
                         random= list(~ 1|study_code,  ~1|obs), data= sdata, method= "REML")

saveRDS(meta_sa_treat3, here("Output", "models", "longevity", "meta_sa_ctemp3.rds"))
} else {
  meta_year <- readRDS(here("Output", "models", "longevity", "meta_long_year.rds"))
  sdata <- readRDS(here("Output", "Output data", "longevity", "sensitivity_data_long.rds"))
  meta_sa_treat3 <- readRDS(here("Output", "models", "longevity", "meta_sa_ctemp3.rds"))
}
```

We found no significant effect of year on effect suggesting that there was no presence of publication bias (*p*-value = `r meta_year$pval[2]`)


```{r, @fig-figyear}
#| label: fig-figyear
#| fig-cap: Bubble plot of mean effect size throughout time.  

q <- bubble_plot(meta_year, mod = "Publication.year", group="study_code") +
  labs(x = "Year of Publication")
q+ coord_cartesian(ylim=c(-20,10))
```

## Treatment temperature

```{r, tbl-sactemp}
#| label: tbl-sactemp
#| tbl-cap: Non-linear effects of temperature on mean effect size of longevity having removed 10% of the most extreme effect sizes. 
table <- data.frame(Parameters = c("Longevity (mean)", "Linear Treatment Temperature (centered) - Longevity","Quadratic Treatment Temperature (centered) - Longevity", "Cubic Treatment Temperature (centered) - Longevity" ),
                    Est. = round(meta_sa_treat3$b, 4),
                    `L 95% CI` = round(meta_sa_treat3$ci.lb, 4),
                    `U 95% CI` = round(meta_sa_treat3$ci.ub, 4),
                    `p-value` = sapply(round(meta_sa_treat3$pval,4), function(x) p_value(x)), row.names = NULL, check.names = FALSE)
flextable(table)
```



## Sex exposed

```{r}
#| echo: false
#| warning: false
#| include: false

if(rerun){
minq <- quantile(new_data$es, 0.05)   
maxq <- quantile(new_data$es, 0.95)

sdata <- subset(new_data, es > minq & es < maxq)
saveRDS(sdata, here("Output", "Output data", "longevity", "sensitivity_data_long_sex.rds"))


## Treatment temperature as a Cubic effect (sesnsitivity analysis)

# re-cmpute the covariance matrix for subsetted data
VCV_shared_sa <- impute_covariance_matrix(vi=sdata$v, cluster = sdata$shared_control, r=0.5)


# re-run cubic model
meta_sa_sex_nointer <- rma.mv(es, VCV_shared_sa,  mod= ~ -1 + poly(c_treattemp, degree=3, raw=TRUE) * Sex.exposed, 
                         random= list(~ 1|study_code,  ~1|obs), data= sdata, method= "REML")

saveRDS(meta_sa_sex_nointer, here("Output", "models", "longevity", "meta_sa_long_sex.rds"))
} else {
  meta_sa_sex <- readRDS(here("Output", "models", "longevity", "meta_sa_long_sex.rds"))
  sa_rep_sexdata <- readRDS(here("Output", "Output data", "longevity", "sensitivity_data_long_sex.rds"))
}

```

The interaction between treatment temperature and sex exposed was also not significant after removing outliers (Interaction between the quadratic effect of (centered) temperature and sex exposed category, z=`r meta_sa_sex$zval[8]`, *p*-value = `r p_value(meta_sa_sex$pval[8])`).


```{r, tbl-sasex}
#| label: tbl-sasex
#| tbl-cap: Non-linear effects of temperature and sex exposed on mean effect size of longevity with 10% most extreme effect sizes removed. 
table <- data.frame(Parameters = c("Linear Treatment Temperature (centered) - Both","Quadratic Treatment Temperature (centered) - Both", "Cubic Treatment Temperature (centered) - Both", "Both (mean)", "Females only (mean)", "Treatment Temperature (centered) - Females only","Quadratic Treatment Temperature (centered) - Females only", "Cubic Treatment Temperature (centered) - Females only"),
                    Est. = round(meta_sa_sex$b, 4),
                    `L 95% CI` = round(meta_sa_sex$ci.lb, 4),
                    `U 95% CI` = round(meta_sa_sex$ci.ub, 4),
                    `p-value` = sapply(round(meta_sa_sex$pval,4), function(x) p_value(x)), row.names = NULL, check.names = FALSE)
flextable(table)

```


```{r, fig-figsexsa}
#| label: fig-figsexsa
#| fig-cap: Predicited models of sex exposed and temeprature effects on longevity.  

preds.rep.sex <- predict(meta_sa_sex, addx=TRUE)
sex_rep_data <- sa_rep_sexdata

sex_rep_data$pred <- preds.rep.sex$pred  
sex_rep_data$pred.lb <- preds.rep.sex$pi.lb
sex_rep_data$pred.ub <- preds.rep.sex$pi.ub
sex_rep_data$c.lb <- preds.rep.sex$ci.lb
sex_rep_data$c.ub <- preds.rep.sex$ci.ub

library(ggplot2)

ggplot(data = sex_rep_data, aes(x = c_treattemp, y = pred, col = Sex.exposed, linetype = Sex.exposed)) +
  geom_ribbon(aes(ymin = c.lb, ymax = c.ub, fill = Sex.exposed), alpha = 0.15) +
  geom_line() +
  scale_color_manual(values = c("purple", "orange")) +  # Set colors for the points and lines
  scale_fill_manual(values = c("purple", "orange")) +    # Set colors for the ribbons
  scale_linetype_manual(values = c("solid", "dashed")) +
  theme_bw() + 
  labs(title = "Predicted Temperature effect on longevity",
       x = "Temperature devaition from 25C",
       y = "Effect size",
       color = "Sex exposed",  # Set the title of the color legend
       fill = "Sex exposed",
       linetype = "Sex exposed")   # Set the title of the fill legend (for ribbons)

```



## Life-stage


```{r}
#| echo: false
#| warning: false
#| include: false

if(rerun){
minq <- quantile(ls_data$es, 0.05)   
maxq <- quantile(ls_data$es, 0.95)

sdata <- subset(ls_data, es > minq & es < maxq)
saveRDS(sdata, here("Output", "Output data", "longevity", "sensitivity_data_long_ls.rds"))


## Treatment temperature as a quadratic effect (sesnsitivity analysis)

# re-cmpute the covariance matrix for subsetted data
VCV_shared_sa <- impute_covariance_matrix(vi=sdata$v, cluster = sdata$shared_control, r=0.5)


# re-run quadratic model
meta_sa_ls_nointer <- rma.mv(es, VCV_shared_sa,  mod= ~ -1 + poly(c_treattemp, degree=3, raw=TRUE) * Life.stage.of.animal, 
                         random= list(~ 1|study_code,  ~1|obs), data= sdata, method= "REML")

saveRDS(meta_sa_ls_nointer, here("Output", "models", "longevity", "meta_sa_long_ls.rds"))
} else {
  meta_sa_ls <- readRDS(here("Output", "models", "longevity", "meta_sa_long_ls.rds"))
  sa_rep_lsdata <- readRDS(here("Output", "Output data", "longevity", "sensitivity_data_long_ls.rds"))
}

```

The relationship between temperature and reproduction did not depend on life stage category after removing outliers (Interaction between the quadratic effect of (centered) temperature and life stage category, z=`r meta_sa_ls$zval[8]`, *p*-value = `r p_value(meta_sa_ls$pval[8])`), Table (@tbl-sals).

```{r, tbl-sals}
#| label: tbl-sals
#| tbl-cap: Non-linear effects of temperature and life stageo animal on mean effect size of longevity after removing the 10% most extreme effect sizes.
table <- data.frame(Parameters = c("Linear Treatment Temperature (centered) - Adult","Quadratic Treatment Temperature (centered) - Adult", "Cubic Treatment Temperature (centered) - Adult",  "Adult (mean)", "Immature (mean)", "Treatment Temperature (centered) - Immature","Quadratic Treatment Temperature (centered) - Immature", "Cubic Treatment Temperature (centered) - Adult"),
                    Est. = round(meta_sa_ls$b, 4),
                    `L 95% CI` = round(meta_sa_ls$ci.lb, 4),
                    `U 95% CI` = round(meta_sa_ls$ci.ub, 4),
                    `p-value` = sapply(round(meta_sa_ls$pval,4), function(x) p_value(x)), row.names = NULL, check.names = FALSE)
flextable(table)
```

```{r, fig-figlssa}
#| label: fig-figlssa
#| fig-cap: Predicited models of sex exposed and temeprature effects on longevity.  

preds.rep.ls <- predict(meta_sa_ls, addx=TRUE)
ls_rep_data <- sa_rep_lsdata

ls_rep_data$pred <- preds.rep.ls$pred  
ls_rep_data$pred.lb <- preds.rep.ls$pi.lb
ls_rep_data$pred.ub <- preds.rep.ls$pi.ub
ls_rep_data$c.lb <- preds.rep.ls$ci.lb
ls_rep_data$c.ub <- preds.rep.ls$ci.ub

library(ggplot2)

ggplot(data = ls_rep_data, aes(x = c_treattemp, y = pred, col = Life.stage.of.animal, linetype = Life.stage.of.animal)) +
  geom_ribbon(aes(ymin = c.lb, ymax = c.ub, fill = Life.stage.of.animal), alpha = 0.15) +
  geom_line() +
  scale_color_manual(values = c("purple", "orange")) +  # Set colors for the points and lines
  scale_fill_manual(values = c("purple", "orange")) +    # Set colors for the ribbons
  scale_linetype_manual(values = c("solid", "dashed")) +
  theme_bw() + 
    coord_cartesian(ylim = c(-7,3))+
  labs(title = "Predicted temperature effect on longevity",
       x = "Observed temperature devaition from 25C",
       y = "Effect size",
       color = "Life stage",  # Set the title of the color legend
       fill = "Life stage",
       linetype = "Life stage")   # Set the title of the fill legend (for ribbons)
```

```{r, sa.remove.24}

#| echo: false
#| warning: false
#| include: false

if(rerun){
  expose.data <- subset(rdata, Exposure.duration != "< 24 hours")
#minq <- quantile(expose.data$es, 0.05)   
#maxq <- quantile(expose.data$es, 0.95)

#sdata <- subset(expose.data, es > minq & es < maxq)

  sdata <- expose.data
saveRDS(sdata, here("Output", "Output data", "longevity", "sensitivity_data_long_exposure.rds"))


## Treatment temperature as a cubic effect (sesnsitivity analysis)

# re-cmpute the covariance matrix for subsetted data
VCV_shared_sa <- impute_covariance_matrix(vi=sdata$v, cluster = sdata$shared_control, r=0.5)


# re-run cubic model
meta_sa_exposure <- rma.mv(es, VCV_shared_sa,  mod= ~poly(c_treattemp, degree=3, raw=TRUE), random=                                list(~ 1|study_code,  ~1|obs), data= sdata, method= "REML")

saveRDS(meta_sa_exposure, here("Output", "models", "longevity", "meta_sa_long_exposure.rds"))
} else {
  meta_sa_exposure <- readRDS(here("Output", "models", "longevity", "meta_sa_long_exposure.rds"))
  sa_exposure <- readRDS(here("Output", "Output data", "longevity", "sensitivity_data_long_exposure.rds"))
}


```

```{r}
#| label: fig-short.exposureremoved
#| fig-cap: Bubble plot of effect size of longevity when controlling for temperature with < 24 hour exposure observations removed. 
p <- bubble_plot(meta_sa_exposure, mod = "c_treattemp", group="study_code")
p+coord_cartesian(ylim=c(-10,10)) + labs(x = "Temperature deviation from 25C")
```

```{r, tbl-saexposure}
#| label: tbl-saexposure
#| tbl-cap: Non-linear effects of temperature on mean effect size of longevity when  < 24 hour exposure times removed.
table <- data.frame(Parameters = c("Longevity (mean)", "Linear Treatment Temperature (centered) - Longevity","Quadratic Treatment Temperature (centered) - Longevity", "Cubic Treatment Temperature (centered) - Longevity" ),
                    Est. = round(meta_sa_exposure$b, 4),
                    `L 95% CI` = round(meta_sa_exposure$ci.lb, 4),
                    `U 95% CI` = round(meta_sa_exposure$ci.ub, 4),
                    `p-value` = sapply(round(meta_sa_exposure$pval,4), function(x) p_value(x)), row.names = NULL, check.names = FALSE)
flextable(table)
```


```{r, higherorderpoly}


if(rerun){
  
  # treat temp^4 centered
meta_trait_treat4 <- rma.mv(es, VCV_shared,  mod= ~poly(c_treattemp, degree=4, raw=TRUE), random= list(~ 1|study_code,  ~1|obs), data= rdata, method= "REML")
saveRDS(meta_trait_treat4, here("Output", "models", "longevity", "mv_rep_ctemp4.rds"))

  # treat temp^5 centered
meta_trait_treat5 <- rma.mv(es, VCV_shared,  mod= ~poly(c_treattemp, degree=5, raw=TRUE), random= list(~ 1|study_code,  ~1|obs), data= rdata, method= "REML")
saveRDS(meta_trait_treat5, here("Output", "models", "longevity", "mv_rep_ctemp5.rds"))

  # treat temp^6 centered
meta_trait_treat6 <- rma.mv(es, VCV_shared,  mod= ~poly(c_treattemp, degree=6, raw=TRUE), random= list(~ 1|study_code,  ~1|obs), data= rdata, method= "REML")
saveRDS(meta_trait_treat6, here("Output", "models", "longevity", "mv_rep_ctemp6.rds"))


  # treat temp^7 centered (fails to converge)
meta_trait_treat7 <- rma.mv(es, VCV_shared,  mod= ~poly(c_treattemp, degree=7, raw=TRUE), random= list(~ 1|study_code,  ~1|obs), data= rdata, method= "REML")
saveRDS(meta_trait_treat7, here("Output", "models", "longevity", "mv_rep_ctemp7.rds"))


  # treat temp^8 centered (fails to converge)
meta_trait_treat8 <- rma.mv(es, VCV_shared,  mod= ~poly(c_treattemp, degree=8, raw=TRUE), random= list(~ 1|study_code,  ~1|obs), data= rdata, method= "REML")
saveRDS(meta_trait_treat8, here("Output", "models", "longevity", "mv_rep_ctemp8.rds"))

} else {
  meta_trait_treat4  <- readRDS(here("Output", "models",  "longevity", "mv_rep_ctemp4.rds"))
  meta_trait_treat5  <- readRDS(here("Output", "models",  "longevity", "mv_rep_ctemp5.rds"))
  meta_trait_treat6  <- readRDS(here("Output", "models",  "longevity", "mv_rep_ctemp6.rds"))

}


```


```{r, fig_long-degree}

preds.2 <- predict(meta_trait_treat2, addx=TRUE)
preds.3 <- predict(meta_trait_treat3, addx=TRUE)
preds.4 <- predict(meta_trait_treat4, addx=TRUE)
preds.5 <- predict(meta_trait_treat5, addx=TRUE)
preds.6 <- predict(meta_trait_treat6, addx=TRUE)

ctemp_data <- rdata

ctemp_data$preds.2 <- preds.2$pred  
ctemp_data$preds.3 <- preds.3$pred  
ctemp_data$preds.4 <- preds.4$pred  
ctemp_data$preds.5 <- preds.5$pred  
ctemp_data$preds.6 <- preds.6$pred  


library(ggplot2)

cbp2 <- c("#000000", "#E69F00", "#56B4E9", "#009E73",
          "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

ggplot(ctemp_data, aes(x = c_treattemp)) +
  geom_point(aes(y = es, size = v), color="black", fill="white", alpha=1/5, size=2) +
  geom_line(aes(y = preds.2, color = "2", linetype= "2"), size = 1.5) +
  geom_line(aes(y = preds.3, color = "3", linetype= "3"), size = 1.5) +
  geom_line(aes(y = preds.4, color = "4", linetype= "4"), size = 1.5) +
  geom_line(aes(y = preds.5, color = "5", linetype= "5"), size = 1.5) +
  geom_line(aes(y = preds.6, color = "6", linetype= "6"), size = 1.5) +
  labs(title = "Predicted effect size curves for longevity using different polynomials",
       x = "Temperature deviation from 25C",
       y = "Effect size") +
  theme_minimal() +
  coord_cartesian(ylim = c(-10, 10)) +
  scale_color_manual(values = c("2" = cbp2[2], "3" = cbp2[3], "4" = cbp2[4], "5" = cbp2[5], "6" = cbp2[8]),
                     name = "Polynomial Degree") +
  scale_linetype_manual(values = c("solid", "dashed", "dotted", "dotdash", "longdash" ), name = "Polynomial Degree")



```